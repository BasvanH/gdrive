name: Build and upload release (linux arm 32bit)

on:
  release:
    types: [created]

env:
  APP_NAME: gdrive
  ARCHIVE_NAME: gdrive_linux-arm.tar.gz
  RING_ALLOW_MISSING_ASM: 1
  CARGO_NET_GIT_FETCH_WITH_CLI: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare upload URL
        run: |
          UPLOAD_URL="$(jq -r '.release.upload_url' "$GITHUB_EVENT_PATH" | sed -e "s/{?name,label}$/?name=${ARCHIVE_NAME}/")"
          echo "UPLOAD_URL=$UPLOAD_URL" >> $GITHUB_ENV

      - name: Install cross-compilation toolchain (glibc 2.30)
        run: |
          sudo apt update
          sudo apt install -y \
            gcc-9-arm-linux-gnueabihf \
            libc6-armhf-cross libc6-dev-armhf-cross \
            binutils-arm-linux-gnueabihf

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: armv7-unknown-linux-gnueabihf

      - name: Build application (glibc 2.30 compatible)
        run: |
          export CC=arm-linux-gnueabihf-gcc
          export CXX=arm-linux-gnueabihf-g++
          export AR=arm-linux-gnueabihf-ar
          export CARGO_TARGET_ARMV7_UNKNOWN_LINUX_GNUEABIHF_LINKER=arm-linux-gnueabihf-gcc
          export RUSTFLAGS="-C linker=arm-linux-gnueabihf-gcc -C target-feature=-crt-static"

          cargo build --release --target=armv7-unknown-linux-gnueabihf

      - name: Check linked glibc version
        run: |
          arm-linux-gnueabihf-readelf -a target/armv7-unknown-linux-gnueabihf/release/$APP_NAME | grep 'GLIBC_'

      - name: Create archive
        run: |
          tar -czf $ARCHIVE_NAME -C target/armv7-unknown-linux-gnueabihf/release $APP_NAME

      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ env.UPLOAD_URL }}
          asset_path: ${{ env.ARCHIVE_NAME }}
          asset_name: ${{ env.ARCHIVE_NAME }}
          asset_content_type: application/gzip
